{"version":3,"sources":["../../../../src/visualBuilder/eventManager/useVariantsPostMessageEvent.ts"],"sourcesContent":["import { VisualBuilder } from \"..\";\nimport { visualBuilderStyles } from \"../visualBuilder.style\";\nimport visualBuilderPostMessage from \"../utils/visualBuilderPostMessage\";\nimport { VisualBuilderPostMessageEvents } from \"../utils/types/postMessage.types\";\nimport { FieldSchemaMap } from \"../utils/fieldSchemaMap\";\nimport { updateVariantClasses } from \"./useRecalculateVariantDataCSLPValues\";\nimport { debounce } from \"lodash-es\";\nimport { extractDetailsFromCslp } from \"../../cslp/cslpdata\";\n\ninterface VariantFieldsEvent {\n    data: {\n        variant_data: {\n            variant: string;\n            highlightVariantFields: boolean;\n            variantOrder: string[];\n        };\n    };\n}\ninterface RemoveVariantFieldsEvent {\n    data: {\n        onlyHighlighted?: boolean;\n    };\n}\n\ninterface AudienceEvent {\n    data: {\n        audienceMode: boolean;\n    };\n}\ninterface VariantEvent {\n    data: {\n        variant: string | null;\n    };\n}\n\ninterface LocaleEvent {\n    data: {\n        locale: string;\n    };\n}\n\nfunction isLowerOrderVariant(variant_uid: string, dataCslp: string, variantOrder: string[]): boolean {\n    if(!variantOrder || variantOrder.length === 0) {\n        return false;\n    }\n    const {variant: cslpVariant} = extractDetailsFromCslp(dataCslp);\n    const indexOfCmsVariant = variantOrder.lastIndexOf(variant_uid);\n    const indexOfCslpVariant = variantOrder.lastIndexOf(cslpVariant || \"\");\n    if(indexOfCslpVariant < 0) {\n        return false;\n    }\n    return indexOfCslpVariant < indexOfCmsVariant;\n}\n\n\nexport function addVariantFieldClass(\n    variant_uid: string\n): void {\n    const variantOrder = VisualBuilder.VisualBuilderGlobalState.value.variantOrder;\n    const highlightVariantFields = VisualBuilder.VisualBuilderGlobalState.value.highlightVariantFields;\n    const elements = document.querySelectorAll(`[data-cslp]`);\n    elements.forEach((element) => {\n        const dataCslp = element.getAttribute(\"data-cslp\");\n        if (!dataCslp) return;\n\n        if (dataCslp?.includes(variant_uid)) {\n            element.classList.add(\"visual-builder__variant-field\");\n            if (highlightVariantFields) {\n                element.classList.add(\n                    visualBuilderStyles()[\"visual-builder__variant-field-outline\"]\n                );\n            }\n        } else if (!dataCslp.startsWith(\"v2:\")) {\n            element.classList.add(\"visual-builder__base-field\");\n        } \n        else if (isLowerOrderVariant(variant_uid, dataCslp, variantOrder)) {\n            element.classList.add(\"visual-builder__variant-field\", \"visual-builder__lower-order-variant-field\");\n        }\n        else {\n            element.classList.add(\"visual-builder__disabled-variant-field\");\n        }\n    });\n}\n\nexport const debounceAddVariantFieldClass = debounce(\n    addVariantFieldClass,\n    1000,\n    { trailing: true }\n) as (variant_uid: string) => void;\n\nexport function removeVariantFieldClass(\n    onlyHighlighted: boolean = false\n): void {\n    if (onlyHighlighted) {\n        const variantElements = document.querySelectorAll(\n            `.${visualBuilderStyles()[\"visual-builder__variant-field-outline\"]}`\n        );\n        variantElements.forEach((element) => {\n            element.classList.remove(\n                visualBuilderStyles()[\"visual-builder__variant-field-outline\"]\n            );\n        });\n    } else {\n        const variantAndBaseFieldElements = document.querySelectorAll(\n            \".visual-builder__disabled-variant-field, .visual-builder__variant-field, .visual-builder__base-field, .visual-builder__lower-order-variant-field\" \n        );\n        variantAndBaseFieldElements.forEach((element) => {\n            element.classList.remove(\n                \"visual-builder__disabled-variant-field\",\n                \"visual-builder__variant-field\",\n                visualBuilderStyles()[\"visual-builder__variant-field-outline\"],\n                \"visual-builder__base-field\",\n                \"visual-builder__lower-order-variant-field\"\n            );\n        });\n    }\n}\n\nexport function setAudienceMode(mode: boolean): void {\n    VisualBuilder.VisualBuilderGlobalState.value.audienceMode = mode;\n}\nexport function setVariant(uid: string | null): void {\n    VisualBuilder.VisualBuilderGlobalState.value.variant = uid;\n}\nexport function setLocale(locale: string): void {\n    VisualBuilder.VisualBuilderGlobalState.value.locale = locale;\n}\nexport function setHighlightVariantFields(highlight: boolean): void {\n    VisualBuilder.VisualBuilderGlobalState.value.highlightVariantFields = highlight;\n}\nexport function setVariantOrder(variantOrder: string[]): void {\n    VisualBuilder.VisualBuilderGlobalState.value.variantOrder = variantOrder;\n}\n\ninterface GetHighlightVariantFieldsStatusResponse {\n    highlightVariantFields: boolean;\n}\nexport async function getHighlightVariantFieldsStatus(): Promise<GetHighlightVariantFieldsStatusResponse> {\n    try {\n        const result = await visualBuilderPostMessage?.send<GetHighlightVariantFieldsStatusResponse>(\n            VisualBuilderPostMessageEvents.GET_HIGHLIGHT_VARIANT_FIELDS_STATUS\n        );   \n        return result ?? {\n            highlightVariantFields: false,\n        };\n    } catch (error) {\n        console.error(\"Failed to get highlight variant fields status:\", error);\n        return {\n            highlightVariantFields: false,\n        };\n    }\n}\n\nexport function useVariantFieldsPostMessageEvent({ isSSR }: { isSSR: boolean }): void {\n    visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.GET_VARIANT_ID,\n        (event: VariantEvent) => {\n            const selectedVariant = event.data.variant;\n            setVariant(selectedVariant);\n            // clear field schema when variant is changed.\n            // this is required as we cache field schema\n            // which contain a key isUnlinkedVariant.\n            // This key can change when variant is changed,\n            // so clear the field schema cache\n            FieldSchemaMap.clear();\n            if (isSSR) {\n                if (selectedVariant) {\n                    addVariantFieldClass(selectedVariant);\n                }\n            } else {\n                // recalculate and apply classes\n                updateVariantClasses();\n            }\n        }\n    );\n    visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.GET_LOCALE,\n        (event: LocaleEvent) => {\n            setLocale(event.data.locale);\n        }\n    );\n    visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.SET_AUDIENCE_MODE,\n        (event: AudienceEvent) => {\n            setAudienceMode(event.data.audienceMode);\n        }\n    );\n    visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.SHOW_VARIANT_FIELDS,\n        (event: VariantFieldsEvent) => {\n            setHighlightVariantFields(event.data.variant_data.highlightVariantFields);\n            setVariantOrder(event.data.variant_data.variantOrder || []);\n            removeVariantFieldClass();\n            addVariantFieldClass(\n                event.data.variant_data.variant\n            );\n        }\n    );\n    visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.REMOVE_VARIANT_FIELDS,\n        (event: RemoveVariantFieldsEvent) => {\n            setHighlightVariantFields(false);\n            removeVariantFieldClass(event?.data?.onlyHighlighted);\n        }\n    );\n}\n"],"mappings":"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","names":["visualBuilderPostMessage"]}