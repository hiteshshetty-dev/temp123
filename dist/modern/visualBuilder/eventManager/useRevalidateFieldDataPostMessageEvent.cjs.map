{"version":3,"sources":["../../../../src/visualBuilder/eventManager/useRevalidateFieldDataPostMessageEvent.ts"],"sourcesContent":["import { VisualBuilder } from \"..\";\nimport { extractDetailsFromCslp } from \"../../cslp\";\nimport { FieldSchemaMap } from \"../utils/fieldSchemaMap\";\nimport { hideFocusOverlay } from \"../generators/generateOverlay\";\nimport { handleBuilderInteraction } from \"../listeners/mouseClick\";\n\n/**\n * Revalidates field data and schema after variant linking operations.\n * Unfocuses the selected element, revalidates data, and then reselects it.\n */\nexport async function handleRevalidateFieldData(): Promise<void> {\n    const focusedElement =\n        VisualBuilder.VisualBuilderGlobalState.value\n            .previousSelectedEditableDOM;\n    const hoveredElement =\n        VisualBuilder.VisualBuilderGlobalState.value.previousHoveredTargetDOM;\n\n    // Store element identifiers for refocusing\n    const elementCslp = focusedElement?.getAttribute(\"data-cslp\");\n    const elementCslpUniqueId =\n        focusedElement?.getAttribute(\"data-cslp-unique-id\") || null;\n    const shouldRefocus = !!focusedElement;\n\n    try {\n        // Step 1: Unfocus the current element\n        if (shouldRefocus) {\n            await unfocusElement();\n        }\n\n        // Step 2: Revalidate field data\n        const targetElement = hoveredElement || focusedElement;\n\n        if (targetElement) {\n            const cslp = targetElement.getAttribute(\"data-cslp\");\n            if (cslp) {\n                const fieldMetadata = extractDetailsFromCslp(cslp);\n\n                // Try to revalidate specific field schema and data\n                // Clear the entire content type schema from cache to force fresh fetch\n                FieldSchemaMap.clearContentTypeSchema(\n                    fieldMetadata.content_type_uid\n                );\n            }\n        }\n\n        // Fallback 1: Clear all field schema cache\n        FieldSchemaMap.clear();\n    } catch (error) {\n        console.error(\"Error handling revalidate field data:\", error);\n        // Final fallback - refresh the page\n        window.location.reload();\n    } finally {\n        // Step 3: Refocus the element if we had one focused before\n        if (shouldRefocus && elementCslp) {\n            await refocusElement(elementCslp, elementCslpUniqueId);\n        }\n    }\n}\n\n/**\n * Unfocuses the currently selected element and clears focus state\n */\nasync function unfocusElement(): Promise<void> {\n    const { visualBuilderContainer, overlayWrapper, focusedToolbar } =\n        getVisualBuilderElements();\n\n    if (!visualBuilderContainer || !overlayWrapper) return;\n\n    const dummyResizeObserver = new ResizeObserver(() => {});\n\n    // Hide focus overlay (cleanIndividualFieldResidual needs previousSelectedEditableDOM)\n    hideFocusOverlay({\n        visualBuilderContainer,\n        visualBuilderOverlayWrapper: overlayWrapper,\n        focusedToolbar,\n        resizeObserver: dummyResizeObserver,\n        noTrigger: true,\n    });\n\n    // Clear global state after cleanup\n    VisualBuilder.VisualBuilderGlobalState.value.previousSelectedEditableDOM =\n        null;\n    VisualBuilder.VisualBuilderGlobalState.value.isFocussed = false;\n}\n\n/**\n * Refocuses an element by its CSLP identifier\n */\nasync function refocusElement(\n    cslp: string,\n    uniqueId: string | null\n): Promise<void> {\n    try {\n        // Find the element (prefer unique ID, fallback to CSLP)\n        const elementToRefocus =\n            (uniqueId &&\n                document.querySelector(\n                    `[data-cslp-unique-id=\"${uniqueId}\"]`\n                )) ||\n            document.querySelector(`[data-cslp=\"${cslp}\"]`);\n\n        if (!elementToRefocus) return;\n\n        const { visualBuilderContainer, overlayWrapper, focusedToolbar } =\n            getVisualBuilderElements();\n\n        if (!visualBuilderContainer || !overlayWrapper) return;\n\n        // Create synthetic click event\n        const syntheticEvent = new MouseEvent(\"click\", {\n            bubbles: true,\n            cancelable: true,\n        });\n        Object.defineProperty(syntheticEvent, \"target\", {\n            value: elementToRefocus,\n            enumerable: true,\n        });\n\n        // Refocus using handleBuilderInteraction\n        await handleBuilderInteraction({\n            event: syntheticEvent,\n            previousSelectedEditableDOM: null,\n            visualBuilderContainer,\n            overlayWrapper,\n            focusedToolbar,\n            resizeObserver: new ResizeObserver(() => {}),\n        });\n    } catch (error) {\n        console.warn(\"Could not refocus element after revalidation:\", error);\n    }\n}\n\n/**\n * Gets the main visual builder DOM elements\n */\nfunction getVisualBuilderElements() {\n    return {\n        visualBuilderContainer: document.querySelector(\n            \".visual-builder__container\"\n        ) as HTMLDivElement | null,\n        overlayWrapper: document.querySelector(\n            \".visual-builder__overlay__wrapper\"\n        ) as HTMLDivElement | null,\n        focusedToolbar: document.querySelector(\n            \".visual-builder__focused-toolbar\"\n        ) as HTMLDivElement | null,\n    };\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA8B;AAC9B,kBAAuC;AACvC,4BAA+B;AAC/B,6BAAiC;AACjC,wBAAyC;AAMzC,eAAsB,4BAA2C;AAC7D,QAAM,iBACF,uBAAc,yBAAyB,MAClC;AACT,QAAM,iBACF,uBAAc,yBAAyB,MAAM;AAGjD,QAAM,cAAc,gBAAgB,aAAa,WAAW;AAC5D,QAAM,sBACF,gBAAgB,aAAa,qBAAqB,KAAK;AAC3D,QAAM,gBAAgB,CAAC,CAAC;AAExB,MAAI;AAEA,QAAI,eAAe;AACf,YAAM,eAAe;AAAA,IACzB;AAGA,UAAM,gBAAgB,kBAAkB;AAExC,QAAI,eAAe;AACf,YAAM,OAAO,cAAc,aAAa,WAAW;AACnD,UAAI,MAAM;AACN,cAAM,oBAAgB,oCAAuB,IAAI;AAIjD,6CAAe;AAAA,UACX,cAAc;AAAA,QAClB;AAAA,MACJ;AAAA,IACJ;AAGA,yCAAe,MAAM;AAAA,EACzB,SAAS,OAAO;AACZ,YAAQ,MAAM,yCAAyC,KAAK;AAE5D,WAAO,SAAS,OAAO;AAAA,EAC3B,UAAE;AAEE,QAAI,iBAAiB,aAAa;AAC9B,YAAM,eAAe,aAAa,mBAAmB;AAAA,IACzD;AAAA,EACJ;AACJ;AAKA,eAAe,iBAAgC;AAC3C,QAAM,EAAE,wBAAwB,gBAAgB,eAAe,IAC3D,yBAAyB;AAE7B,MAAI,CAAC,0BAA0B,CAAC,eAAgB;AAEhD,QAAM,sBAAsB,IAAI,eAAe,MAAM;AAAA,EAAC,CAAC;AAGvD,+CAAiB;AAAA,IACb;AAAA,IACA,6BAA6B;AAAA,IAC7B;AAAA,IACA,gBAAgB;AAAA,IAChB,WAAW;AAAA,EACf,CAAC;AAGD,yBAAc,yBAAyB,MAAM,8BACzC;AACJ,yBAAc,yBAAyB,MAAM,aAAa;AAC9D;AAKA,eAAe,eACX,MACA,UACa;AACb,MAAI;AAEA,UAAM,mBACD,YACG,SAAS;AAAA,MACL,yBAAyB,QAAQ;AAAA,IACrC,KACJ,SAAS,cAAc,eAAe,IAAI,IAAI;AAElD,QAAI,CAAC,iBAAkB;AAEvB,UAAM,EAAE,wBAAwB,gBAAgB,eAAe,IAC3D,yBAAyB;AAE7B,QAAI,CAAC,0BAA0B,CAAC,eAAgB;AAGhD,UAAM,iBAAiB,IAAI,WAAW,SAAS;AAAA,MAC3C,SAAS;AAAA,MACT,YAAY;AAAA,IAChB,CAAC;AACD,WAAO,eAAe,gBAAgB,UAAU;AAAA,MAC5C,OAAO;AAAA,MACP,YAAY;AAAA,IAChB,CAAC;AAGD,cAAM,4CAAyB;AAAA,MAC3B,OAAO;AAAA,MACP,6BAA6B;AAAA,MAC7B;AAAA,MACA;AAAA,MACA;AAAA,MACA,gBAAgB,IAAI,eAAe,MAAM;AAAA,MAAC,CAAC;AAAA,IAC/C,CAAC;AAAA,EACL,SAAS,OAAO;AACZ,YAAQ,KAAK,iDAAiD,KAAK;AAAA,EACvE;AACJ;AAKA,SAAS,2BAA2B;AAChC,SAAO;AAAA,IACH,wBAAwB,SAAS;AAAA,MAC7B;AAAA,IACJ;AAAA,IACA,gBAAgB,SAAS;AAAA,MACrB;AAAA,IACJ;AAAA,IACA,gBAAgB,SAAS;AAAA,MACrB;AAAA,IACJ;AAAA,EACJ;AACJ;","names":[]}