{"version":3,"sources":["../../../../src/visualBuilder/eventManager/useCollab.ts"],"sourcesContent":["import visualBuilderPostMessage from \"../utils/visualBuilderPostMessage\";\nimport { VisualBuilderPostMessageEvents } from \"../utils/types/postMessage.types\";\nimport Config from \"../../configManager/configManager\";\nimport {\n    removeAllCollabIcons,\n    hideAllCollabIcons,\n    removeCollabIcon,\n    HighlightThread,\n    showAllCollabIcons,\n} from \"../generators/generateThread\";\nimport {\n    generateThread,\n    handleMissingThreads,\n} from \"../generators/generateThread\";\nimport {\n    IThreadDTO,\n    ICollabConfig,\n    IThreadIdentifier,\n    IThreadRemove,\n    IThreadReopen,\n} from \"../types/collab.types\";\nimport { OnEvent } from \"@contentstack/advanced-post-message\";\n\nconst handleRemoveCommentIcons = (fromShare: boolean = false): void => {\n    if (fromShare) {\n        hideAllCollabIcons();\n        return;\n    }\n    removeAllCollabIcons();\n};\n\nexport const useCollab = () => {\n    const config = Config.get();\n    const collabEnable = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_ENABLE,\n        (data: OnEvent<ICollabConfig>) => {\n            if (!data?.data?.collab) {\n                console.error(\"Invalid collab data structure:\", data);\n                return;\n            }\n            if (data?.data?.collab?.fromShare) {\n                Config.set(\n                    \"collab.pauseFeedback\",\n                    data?.data?.collab?.pauseFeedback\n                );\n                showAllCollabIcons();\n                return;\n            }\n\n            Config.set(\"collab.enable\", data.data.collab.enable ?? false);\n            Config.set(\n                \"collab.isFeedbackMode\",\n                data.data.collab.isFeedbackMode ?? false\n            );\n            Config.set(\n                \"collab.pauseFeedback\",\n                data?.data?.collab?.pauseFeedback\n            );\n            Config.set(\n                \"collab.inviteMetadata\",\n                data.data.collab.inviteMetadata\n            );\n        }\n    );\n\n    const collabPayload = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_DATA_UPDATE,\n        (data: OnEvent<ICollabConfig>) => {\n            if (!config?.collab?.enable) return;\n\n            if (!data?.data?.collab) {\n                console.error(\"Invalid collab data structure:\", data);\n                return;\n            }\n\n            if (data?.data?.collab?.inviteMetadata) {\n                Config.set(\n                    \"collab.inviteMetadata\",\n                    data?.data?.collab?.inviteMetadata\n                );\n                return;\n            }\n\n            const missingThreadIds =\n                data?.data?.collab?.payload\n                    ?.map((payload: IThreadDTO) => generateThread(payload))\n                    .filter((id): id is string => id !== undefined) || [];\n            if (missingThreadIds.length > 0) {\n                handleMissingThreads({\n                    payload: { isElementPresent: false },\n                    threadUids: missingThreadIds,\n                });\n            }\n        }\n    );\n\n    const collabDisable = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_DISABLE,\n        (data: OnEvent<ICollabConfig>) => {\n            if (data?.data?.collab?.fromShare) {\n                Config.set(\n                    \"collab.pauseFeedback\",\n                    data?.data?.collab?.pauseFeedback\n                );\n                handleRemoveCommentIcons(true);\n                return;\n            }\n\n            Config.set(\"collab.enable\", false);\n            Config.set(\"collab.isFeedbackMode\", false);\n\n            handleRemoveCommentIcons();\n        }\n    );\n\n    const collabThreadRemove = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_THREADS_REMOVE,\n        (data: OnEvent<IThreadRemove>) => {\n            const threadUids = data?.data?.threadUids;\n\n            if (!config?.collab?.enable) return;\n\n            if (data?.data?.updateConfig) {\n                Config.set(\"collab.isFeedbackMode\", true);\n            }\n            if (threadUids.length > 0) {\n                threadUids.forEach((threadUid) => {\n                    removeCollabIcon(threadUid);\n                });\n            }\n        }\n    );\n\n    const collabThreadReopen = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_THREAD_REOPEN,\n        (data: OnEvent<IThreadReopen>) => {\n            const thread = data.data.thread;\n\n            if (!config?.collab?.enable) return;\n\n            const result = generateThread(thread, {\n                hidden: Boolean(config?.collab?.pauseFeedback),\n            });\n            if (result) {\n                handleMissingThreads({\n                    payload: { isElementPresent: false },\n                    threadUids: [result],\n                });\n            }\n        }\n    );\n\n    const collabThreadHighlight = visualBuilderPostMessage?.on(\n        VisualBuilderPostMessageEvents.COLLAB_THREAD_HIGHLIGHT,\n        (data: OnEvent<IThreadIdentifier>) => {\n            const { threadUid } = data.data;\n            if (!config?.collab?.enable || config?.collab?.pauseFeedback)\n                return;\n\n            HighlightThread(threadUid);\n        }\n    );\n\n    return () => {\n        collabEnable?.unregister();\n        collabPayload?.unregister();\n        collabDisable?.unregister();\n        collabThreadRemove?.unregister();\n        collabThreadReopen?.unregister();\n        collabThreadHighlight?.unregister();\n    };\n};\n"],"mappings":"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","names":[]}