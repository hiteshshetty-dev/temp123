{"version":3,"sources":["../../../../src/visualBuilder/utils/isFieldDisabled.ts"],"sourcesContent":["import Config from \"../../configManager/configManager\";\nimport { ISchemaFieldMap } from \"./types/index.types\";\nimport { VisualBuilder } from \"..\";\nimport { FieldDetails } from \"../components/FieldToolbar\";\nimport { EntryPermissions } from \"./getEntryPermissions\";\nimport { WorkflowStageDetails } from \"./getWorkflowStageDetails\";\n\nconst DisableReason = {\n    ReadOnly: \"You have only read access to this field\",\n    LocalizedEntry: \"Editing this field is restricted in localized entries\",\n    UnlinkedVariant:\n        \"This field is not editable as it is not linked to the selected variant\",\n    AudienceMode: \"To edit an experience, open the Audience widget and click the Edit icon.\",\n    DisabledVariant:\n        \"This field is not editable as it doesn't match the selected variant\",\n    UnlocalizedVariant: \"This field is not editable as it is not localized\",\n    None: \"\",\n    EntryUpdateRestricted: \"You do not have permission to edit this entry\",\n    WorkflowStagePermission: ({ stageName }: { stageName: string }) =>\n        `You do not have Edit access to this entry on the '${stageName}' workflow stage`,\n    EntryUpdateRestrictedRoleAndWorkflowStage: ({\n        stageName,\n    }: {\n        stageName: string;\n    }) =>\n        `Editing is restricted for your role or by the rules for the '${stageName}' stage. Contact your admin for edit access.`,\n} as const;\n\ninterface FieldDisableState {\n    isDisabled: boolean;\n    reason: string;\n}\n\nconst getDisableReason = (\n    flags: Record<string, boolean>,\n    params?: Record<string, any>\n) => {\n    if (flags.updateRestrictDueToRole) return DisableReason.ReadOnly;\n    if (flags.updateRestrictDueToNonLocalizableFields)\n        return DisableReason.LocalizedEntry;\n    if (flags.updateRestrictDueToUnlocalizedVariant)\n        return DisableReason.UnlocalizedVariant;\n    if (flags.updateRestrictDueToUnlinkVariant)\n        return DisableReason.UnlinkedVariant;\n    if (flags.updateRestrictDueToAudienceMode)\n        return DisableReason.AudienceMode;\n    if (flags.updateRestrictDueToDisabledVariant)\n        return DisableReason.DisabledVariant;\n    if (\n        flags.updateRestrictDueToEntryUpdateRestriction &&\n        flags.updateRestrictDueToWorkflowStagePermission\n    ) {\n        return DisableReason.EntryUpdateRestrictedRoleAndWorkflowStage({\n            stageName: params?.stageName ? params.stageName : \"Unknown\",\n        });\n    }\n    if (flags.updateRestrictDueToEntryUpdateRestriction) {\n        return DisableReason.EntryUpdateRestricted;\n    }\n    if (flags.updateRestrictDueToWorkflowStagePermission) {\n        return DisableReason.WorkflowStagePermission({\n            stageName: params?.stageName ? params.stageName : \"Unknown\",\n        });\n    }\n    return DisableReason.None;\n};\n\nexport const isFieldDisabled = (\n    fieldSchemaMap: ISchemaFieldMap,\n    eventFieldDetails: FieldDetails,\n    entryPermissions?: EntryPermissions,\n    entryWorkflowStageDetails?: WorkflowStageDetails\n): FieldDisableState => {\n    const { editableElement, fieldMetadata } = eventFieldDetails;\n    const masterLocale = Config.get().stackDetails.masterLocale || \"en-us\";\n    const { locale: cmsLocale, variant } =\n        VisualBuilder.VisualBuilderGlobalState.value;\n\n    const flags: Record<string, boolean> = {\n        updateRestrictDueToRole: Boolean(\n            fieldSchemaMap?.field_metadata?.updateRestrict\n        ),\n        updateRestrictDueToUnlinkVariant: Boolean(\n            fieldSchemaMap?.field_metadata?.isUnlinkedVariant\n        ),\n        updateRestrictDueToUnlocalizedVariant: Boolean(\n            variant && fieldMetadata.locale !== cmsLocale\n        ),\n        updateRestrictDueToNonLocalizableFields: Boolean(\n            fieldSchemaMap?.non_localizable &&\n                masterLocale !== fieldMetadata.locale\n        ),\n        updateRestrictDueToAudienceMode: false,\n        updateRestrictDueToDisabledVariant: false,\n    };\n\n    if (entryPermissions && !entryPermissions.update) {\n        flags.updateRestrictDueToEntryUpdateRestriction = true;\n    }\n\n    if (\n        entryWorkflowStageDetails &&\n        !entryWorkflowStageDetails.permissions.entry.update\n    ) {\n        flags.updateRestrictDueToWorkflowStagePermission = true;\n    }\n\n    if (\n        VisualBuilder.VisualBuilderGlobalState.value.audienceMode &&\n        !editableElement.classList.contains(\"visual-builder__variant-field\") &&\n        !editableElement.classList.contains(\"visual-builder__base-field\")\n    ) {\n        if (\n            editableElement.classList.contains(\n                \"visual-builder__disabled-variant-field\"\n            )\n        ) {\n            flags.updateRestrictDueToDisabledVariant = true;\n        } else {\n            flags.updateRestrictDueToAudienceMode = true;\n        }\n    }\n\n    const isDisabled = Object.values(flags).some(Boolean);\n    const reason = getDisableReason(flags, {\n        stageName: entryWorkflowStageDetails?.stage?.name,\n    });\n\n    return { isDisabled, reason };\n};\n"],"mappings":";;;AAAA,OAAO,YAAY;AAEnB,SAAS,qBAAqB;AAK9B,IAAM,gBAAgB;AAAA,EAClB,UAAU;AAAA,EACV,gBAAgB;AAAA,EAChB,iBACI;AAAA,EACJ,cAAc;AAAA,EACd,iBACI;AAAA,EACJ,oBAAoB;AAAA,EACpB,MAAM;AAAA,EACN,uBAAuB;AAAA,EACvB,yBAAyB,CAAC,EAAE,UAAU,MAClC,qDAAqD,SAAS;AAAA,EAClE,2CAA2C,CAAC;AAAA,IACxC;AAAA,EACJ,MAGI,gEAAgE,SAAS;AACjF;AAOA,IAAM,mBAAmB,CACrB,OACA,WACC;AACD,MAAI,MAAM,wBAAyB,QAAO,cAAc;AACxD,MAAI,MAAM;AACN,WAAO,cAAc;AACzB,MAAI,MAAM;AACN,WAAO,cAAc;AACzB,MAAI,MAAM;AACN,WAAO,cAAc;AACzB,MAAI,MAAM;AACN,WAAO,cAAc;AACzB,MAAI,MAAM;AACN,WAAO,cAAc;AACzB,MACI,MAAM,6CACN,MAAM,4CACR;AACE,WAAO,cAAc,0CAA0C;AAAA,MAC3D,WAAW,QAAQ,YAAY,OAAO,YAAY;AAAA,IACtD,CAAC;AAAA,EACL;AACA,MAAI,MAAM,2CAA2C;AACjD,WAAO,cAAc;AAAA,EACzB;AACA,MAAI,MAAM,4CAA4C;AAClD,WAAO,cAAc,wBAAwB;AAAA,MACzC,WAAW,QAAQ,YAAY,OAAO,YAAY;AAAA,IACtD,CAAC;AAAA,EACL;AACA,SAAO,cAAc;AACzB;AAEO,IAAM,kBAAkB,CAC3B,gBACA,mBACA,kBACA,8BACoB;AACpB,QAAM,EAAE,iBAAiB,cAAc,IAAI;AAC3C,QAAM,eAAe,OAAO,IAAI,EAAE,aAAa,gBAAgB;AAC/D,QAAM,EAAE,QAAQ,WAAW,QAAQ,IAC/B,cAAc,yBAAyB;AAE3C,QAAM,QAAiC;AAAA,IACnC,yBAAyB;AAAA,MACrB,gBAAgB,gBAAgB;AAAA,IACpC;AAAA,IACA,kCAAkC;AAAA,MAC9B,gBAAgB,gBAAgB;AAAA,IACpC;AAAA,IACA,uCAAuC;AAAA,MACnC,WAAW,cAAc,WAAW;AAAA,IACxC;AAAA,IACA,yCAAyC;AAAA,MACrC,gBAAgB,mBACZ,iBAAiB,cAAc;AAAA,IACvC;AAAA,IACA,iCAAiC;AAAA,IACjC,oCAAoC;AAAA,EACxC;AAEA,MAAI,oBAAoB,CAAC,iBAAiB,QAAQ;AAC9C,UAAM,4CAA4C;AAAA,EACtD;AAEA,MACI,6BACA,CAAC,0BAA0B,YAAY,MAAM,QAC/C;AACE,UAAM,6CAA6C;AAAA,EACvD;AAEA,MACI,cAAc,yBAAyB,MAAM,gBAC7C,CAAC,gBAAgB,UAAU,SAAS,+BAA+B,KACnE,CAAC,gBAAgB,UAAU,SAAS,4BAA4B,GAClE;AACE,QACI,gBAAgB,UAAU;AAAA,MACtB;AAAA,IACJ,GACF;AACE,YAAM,qCAAqC;AAAA,IAC/C,OAAO;AACH,YAAM,kCAAkC;AAAA,IAC5C;AAAA,EACJ;AAEA,QAAM,aAAa,OAAO,OAAO,KAAK,EAAE,KAAK,OAAO;AACpD,QAAM,SAAS,iBAAiB,OAAO;AAAA,IACnC,WAAW,2BAA2B,OAAO;AAAA,EACjD,CAAC;AAED,SAAO,EAAE,YAAY,OAAO;AAChC;","names":[]}